{% extends "base.html" %}

{% block title %}Logs - InferBench{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-file-text"></i> Logs</h1>
        <p class="text-muted">View and search service and benchmark logs</p>
    </div>
</div>

<!-- Log Viewer -->
<div class="card">
    <div class="card-header">
        <div class="row align-items-center">
            <div class="col-md-3">
                <select class="form-select form-select-sm" id="log-source-type">
                    <option value="service">Service</option>
                    <option value="client">Benchmark</option>
                </select>
            </div>
            <div class="col-md-4">
                <select class="form-select form-select-sm" id="log-source-id">
                    <option value="">Select source...</option>
                </select>
            </div>
            <div class="col-md-2">
                <select class="form-select form-select-sm" id="log-type">
                    <option value="output">Output</option>
                    <option value="error">Error</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control form-control-sm" id="log-lines" value="100" min="10" max="1000">
            </div>
            <div class="col-md-1">
                <button class="btn btn-sm btn-primary w-100" onclick="loadLogs()">
                    <i class="bi bi-arrow-clockwise"></i>
                </button>
            </div>
        </div>
    </div>
    <div class="card-body">
        <pre id="log-content" class="bg-dark text-light p-3" style="max-height: 600px; overflow-y: auto; font-size: 12px;">Select a source to view logs...</pre>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
async function loadSources() {
    const sourceType = document.getElementById('log-source-type').value;
    const select = document.getElementById('log-source-id');
    
    select.innerHTML = '<option value="">Loading...</option>';
    
    try {
        let response, data;
        
        if (sourceType === 'service') {
            response = await fetch('/api/services');
            data = await response.json();
            
            select.innerHTML = '<option value="">Select a service...</option>';
            data.services.forEach(svc => {
                select.innerHTML += `<option value="${svc.id}">${svc.recipe_name} (${svc.id.substring(0, 8)}...)</option>`;
            });
        } else {
            response = await fetch('/api/benchmarks');
            data = await response.json();
            
            select.innerHTML = '<option value="">Select a benchmark...</option>';
            data.runs.forEach(run => {
                select.innerHTML += `<option value="${run.id}">${run.recipe_name} (${run.id.substring(0, 8)}...)</option>`;
            });
        }
    } catch (error) {
        select.innerHTML = '<option value="">Failed to load</option>';
    }
}

async function loadLogs() {
    const sourceType = document.getElementById('log-source-type').value;
    const sourceId = document.getElementById('log-source-id').value;
    const logType = document.getElementById('log-type').value;
    const lines = document.getElementById('log-lines').value;
    
    if (!sourceId) {
        alert('Please select a source');
        return;
    }
    
    const content = document.getElementById('log-content');
    content.textContent = 'Loading...';
    
    try {
        const endpoint = sourceType === 'service' 
            ? `/api/logs/service/${sourceId}?type=${logType}&lines=${lines}`
            : `/api/logs/client/${sourceId}?type=${logType}&lines=${lines}`;
        
        const response = await fetch(endpoint);
        const data = await response.json();
        
        if (data.error) {
            content.textContent = `Error: ${data.error}`;
        } else {
            content.textContent = data.content || 'No logs available';
        }
    } catch (error) {
        content.textContent = `Error: ${error.message}`;
    }
}

// Event listeners
document.getElementById('log-source-type').addEventListener('change', loadSources);

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadSources();
});
</script>
{% endblock %}
