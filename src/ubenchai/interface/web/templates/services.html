{% extends "base.html" %}

{% block title %}Services - UBenchAI{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-server"></i> Services</h1>
        <p class="text-muted">Manage AI inference servers and services</p>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" onclick="showStartServiceModal()">
            <i class="bi bi-plus-circle"></i> Start Service
        </button>
    </div>
</div>

<!-- Available Recipes -->
<div class="card mb-4">
    <div class="card-header">
        <i class="bi bi-book"></i> Available Recipes
    </div>
    <div class="card-body">
        <div id="server-recipes" class="row">
            <p class="text-muted">Loading recipes...</p>
        </div>
    </div>
</div>

<!-- Running Services -->
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="bi bi-activity"></i> Services <small class="text-muted ms-2" id="last-refresh"></small></span>
        <div>
            <span class="badge bg-success me-2" id="auto-refresh-badge">Auto-refresh: ON</span>
            <button class="btn btn-sm btn-outline-secondary" onclick="loadServices()">
                <i class="bi bi-arrow-clockwise"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Recipe</th>
                        <th>Status</th>
                        <th>Node</th>
                        <th>Job ID</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="services-table-body">
                    <tr><td colspan="7" class="text-center text-muted">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Start Service Modal -->
<div class="modal fade" id="startServiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Start Service</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Select Recipe</label>
                    <select class="form-select" id="service-recipe-select">
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div id="recipe-details" class="alert alert-info d-none">
                    <strong>Description:</strong> <span id="recipe-description"></span><br>
                    <strong>Resources:</strong> <span id="recipe-resources"></span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="startService()">Start Service</button>
            </div>
        </div>
    </div>
</div>

<!-- Service Details Modal -->
<div class="modal fade" id="serviceDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Service Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="service-details-content">
                Loading...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let serverRecipes = [];

async function loadServerRecipes() {
    try {
        const response = await fetch('/api/recipes/servers');
        const data = await response.json();
        serverRecipes = data.recipes;
        
        const container = document.getElementById('server-recipes');
        const select = document.getElementById('service-recipe-select');
        
        container.innerHTML = '';
        select.innerHTML = '<option value="">Select a recipe...</option>';
        
        data.recipes.forEach(recipe => {
            container.innerHTML += `
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <h6 class="card-title">${recipe.name}</h6>
                            <p class="card-text small text-muted">${recipe.description || 'No description'}</p>
                            <small class="text-muted">
                                <i class="bi bi-cpu"></i> ${recipe.resources?.nodes || 1} node(s)
                                <i class="bi bi-gpu-card ms-2"></i> ${recipe.resources?.gpus || 0} GPU(s)
                            </small>
                        </div>
                    </div>
                </div>
            `;
            select.innerHTML += `<option value="${recipe.name}">${recipe.name}</option>`;
        });
    } catch (error) {
        console.error('Failed to load recipes:', error);
    }
}

async function loadServices() {
    try {
        const response = await fetch('/api/services');
        const data = await response.json();
        
        const tbody = document.getElementById('services-table-body');
        const lastRefresh = document.getElementById('last-refresh');
        
        // Update last refresh time
        if (lastRefresh) {
            lastRefresh.textContent = `Updated: ${new Date().toLocaleTimeString()}`;
        }
        
        if (data.services.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No services</td></tr>';
            return;
        }
        
        tbody.innerHTML = '';
        data.services.forEach(svc => {
            const statusClass = svc.status === 'running' ? 'success' : 
                               svc.status === 'error' ? 'danger' : 
                               svc.status === 'failed' ? 'danger' :
                               svc.status === 'pending' ? 'warning' : 
                               svc.status === 'starting' ? 'info' : 'secondary';
            
            tbody.innerHTML += `
                <tr>
                    <td><code>${svc.id.substring(0, 8)}</code></td>
                    <td>${svc.recipe_name}</td>
                    <td><span class="badge bg-${statusClass}">${svc.status}</span></td>
                    <td>${svc.node || '-'}</td>
                    <td>${svc.slurm_job_id || '-'}</td>
                    <td>${new Date(svc.created_at).toLocaleString()}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-info" onclick="showServiceDetails('${svc.id}')">
                            <i class="bi bi-info-circle"></i>
                        </button>
                        ${svc.status === 'running' || svc.status === 'starting' ? `
                        <button class="btn btn-sm btn-outline-danger" onclick="stopService('${svc.id}')">
                            <i class="bi bi-stop-circle"></i>
                        </button>
                        ` : ''}
                    </td>
                </tr>
            `;
        });
    } catch (error) {
        console.error('Failed to load services:', error);
    }
}

function showStartServiceModal() {
    new bootstrap.Modal(document.getElementById('startServiceModal')).show();
}

async function startService() {
    const recipe = document.getElementById('service-recipe-select').value;
    if (!recipe) {
        alert('Please select a recipe');
        return;
    }
    
    try {
        const response = await fetch('/api/services', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recipe: recipe})
        });
        const data = await response.json();
        
        if (response.ok) {
            alert(`Service started! ID: ${data.service_id}`);
            bootstrap.Modal.getInstance(document.getElementById('startServiceModal')).hide();
            loadServices();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function stopService(serviceId) {
    if (!confirm('Are you sure you want to stop this service?')) return;
    
    try {
        const response = await fetch(`/api/services/${serviceId}`, {method: 'DELETE'});
        const data = await response.json();
        
        if (response.ok) {
            alert('Service stopped');
            loadServices();
        } else {
            alert(`Error: ${data.error}`);
        }
    } catch (error) {
        alert(`Error: ${error.message}`);
    }
}

async function showServiceDetails(serviceId) {
    const modal = new bootstrap.Modal(document.getElementById('serviceDetailsModal'));
    const content = document.getElementById('service-details-content');
    content.innerHTML = 'Loading...';
    modal.show();
    
    try {
        const response = await fetch(`/api/services/${serviceId}`);
        const data = await response.json();
        
        content.innerHTML = `
            <table class="table">
                <tr><th>ID</th><td><code>${data.id}</code></td></tr>
                <tr><th>Recipe</th><td>${data.recipe_name}</td></tr>
                <tr><th>Status</th><td><span class="badge bg-${data.status === 'running' ? 'success' : 'secondary'}">${data.status}</span></td></tr>
                <tr><th>Node</th><td>${data.node || '-'}</td></tr>
                <tr><th>SLURM Job ID</th><td>${data.slurm_job_id || '-'}</td></tr>
                <tr><th>Created</th><td>${new Date(data.created_at).toLocaleString()}</td></tr>
                <tr><th>Started</th><td>${data.started_at ? new Date(data.started_at).toLocaleString() : '-'}</td></tr>
                <tr><th>Endpoints</th><td><pre>${JSON.stringify(data.endpoints || {}, null, 2)}</pre></td></tr>
                ${data.error_message ? `<tr><th>Error</th><td class="text-danger">${data.error_message}</td></tr>` : ''}
            </table>
        `;
    } catch (error) {
        content.innerHTML = `<p class="text-danger">Failed to load details: ${error.message}</p>`;
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    loadServerRecipes();
    loadServices();
    
    // Auto-refresh every 5 seconds
    setInterval(() => {
        loadServices();
        console.log('Auto-refreshed services at', new Date().toLocaleTimeString());
    }, 5000);
});
</script>
{% endblock %}
